<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Bottle Monitoring Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        #video-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #video-feed {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #graph-container {
            height: 500px;
        }

        .status {
            text-align: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            color: #666;
            font-size: 0.9em;
        }

        #alerts-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        #alerts-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #alerts-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #alerts-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1em;
        }

        #alerts-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        #alerts-table tbody tr:hover {
            background: #f9f9f9;
        }

        #alerts-table tbody tr:last-child td {
            border-bottom: none;
        }

        .alert-row {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¥› Milk Bottle Monitoring Dashboard</h1>
            <p>Real-time inventory tracking and analytics</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('video')">ðŸ“¹ Live Video</button>
            <button class="tab" onclick="switchTab('graph')">ðŸ“Š Analytics</button>
            <button class="tab" onclick="switchTab('alerts')">ðŸš¨ Alerts</button>
        </div>

        <div id="video-tab" class="tab-content active">
            <div class="status">
                <span class="status-indicator"></span>
                <strong>Live Stream Active</strong>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <h3>Whole Milk</h3>
                    <div class="value" id="video-whole">0</div>
                </div>
                <div class="stat-card">
                    <h3>1% Milk</h3>
                    <div class="value" id="video-1pct">0</div>
                </div>
                <div class="stat-card">
                    <h3>2% Milk</h3>
                    <div class="value" id="video-2pct">0</div>
                </div>
            </div>
            <div id="video-container">
                <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Live Video Feed">
            </div>
        </div>

        <div id="graph-tab" class="tab-content">
            <div class="status">
                <span class="status-indicator"></span>
                <strong>Real-time Data Updates</strong>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <h3>Whole Milk</h3>
                    <div class="value" id="current-whole">0</div>
                </div>
                <div class="stat-card">
                    <h3>1% Milk</h3>
                    <div class="value" id="current-1pct">0</div>
                </div>
                <div class="stat-card">
                    <h3>2% Milk</h3>
                    <div class="value" id="current-2pct">0</div>
                </div>
            </div>
            <div id="graph-container"></div>
        </div>

        <div id="alerts-tab" class="tab-content">
            <div class="status">
                <span class="status-indicator"></span>
                <strong>Alert History (500 second cooldown)</strong>
            </div>

            <div class="stats">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3>Total Alerts</h3>
                    <div class="value" id="total-alerts">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3>Whole Milk Alerts</h3>
                    <div class="value" id="whole-alerts">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3>1% Milk Alerts</h3>
                    <div class="value" id="1pct-alerts">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h3>2% Milk Alerts</h3>
                    <div class="value" id="2pct-alerts">0</div>
                </div>
            </div>

            <div id="alerts-container">
                <table id="alerts-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Missing Categories</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-tbody">
                        <tr>
                            <td colspan="2" style="text-align: center; color: #999;">No alerts yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>Powered by Roboflow Workflows | Real-time monitoring system</p>
        </footer>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Initialize Plotly graph
        let graphData = {
            timestamps: [],
            whole: [],
            '1pct': [],
            '2pct': []
        };

        function initGraph() {
            const layout = {
                title: 'Milk Bottle Counts (Past Hour)',
                xaxis: {
                    title: 'Time',
                    type: 'date'
                },
                yaxis: {
                    title: 'Count',
                    range: [0, 2],
                    fixedrange: false,
                    tickmode: 'array',
                    tickvals: [0, 1, 2]
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1
                }
            };

            const traces = [
                {
                    x: [],
                    y: [],
                    name: 'Whole Milk',
                    mode: 'lines+markers',
                    line: { color: 'blue', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: [],
                    y: [],
                    name: '1% Milk',
                    mode: 'lines+markers',
                    line: { color: 'green', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: [],
                    y: [],
                    name: '2% Milk',
                    mode: 'lines+markers',
                    line: { color: 'red', width: 2 },
                    marker: { size: 6 }
                }
            ];

            Plotly.newPlot('graph-container', traces, layout, {responsive: true});
        }

        function updateGraph(data) {
            if (!data || !data.timestamps) return;

            graphData = data;

            const update = {
                x: [data.timestamps, data.timestamps, data.timestamps],
                y: [data.whole, data['1pct'], data['2pct']]
            };

            Plotly.update('graph-container', update, {}, [0, 1, 2]);

            // Update current count cards
            if (data.whole.length > 0) {
                document.getElementById('current-whole').textContent = data.whole[data.whole.length - 1];
            }
            if (data['1pct'].length > 0) {
                document.getElementById('current-1pct').textContent = data['1pct'][data['1pct'].length - 1];
            }
            if (data['2pct'].length > 0) {
                document.getElementById('current-2pct').textContent = data['2pct'][data['2pct'].length - 1];
            }
        }

        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('graph_update', function(data) {
            console.log('Graph update received:', data);
            updateGraph(data);

            // Also update video tab counts
            if (data.whole.length > 0) {
                document.getElementById('video-whole').textContent = data.whole[data.whole.length - 1];
            }
            if (data['1pct'].length > 0) {
                document.getElementById('video-1pct').textContent = data['1pct'][data['1pct'].length - 1];
            }
            if (data['2pct'].length > 0) {
                document.getElementById('video-2pct').textContent = data['2pct'][data['2pct'].length - 1];
            }
        });

        socket.on('alerts_initial', function(data) {
            console.log('Initial alerts received:', data);
            updateAlertsTable(data);
        });

        socket.on('alert_update', function(data) {
            console.log('New alert received:', data);
            addAlertRow(data);
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });

        // Alerts functions
        function calculateAlertStats(alerts) {
            const stats = {
                total: alerts.length,
                whole: 0,
                '1pct': 0,
                '2pct': 0
            };

            alerts.forEach(alert => {
                const categories = alert.missing_categories.toLowerCase();
                if (categories.includes('whole milk')) {
                    stats.whole++;
                }
                if (categories.includes('1% milk')) {
                    stats['1pct']++;
                }
                if (categories.includes('2% milk')) {
                    stats['2pct']++;
                }
            });

            return stats;
        }

        function updateAlertStats(stats) {
            document.getElementById('total-alerts').textContent = stats.total;
            document.getElementById('whole-alerts').textContent = stats.whole;
            document.getElementById('1pct-alerts').textContent = stats['1pct'];
            document.getElementById('2pct-alerts').textContent = stats['2pct'];
        }

        function updateAlertsTable(alerts) {
            const tbody = document.getElementById('alerts-tbody');
            tbody.innerHTML = '';

            if (!alerts || alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #999;">No alerts yet</td></tr>';
                updateAlertStats({ total: 0, whole: 0, '1pct': 0, '2pct': 0 });
                return;
            }

            // Update stats
            const stats = calculateAlertStats(alerts);
            updateAlertStats(stats);

            // Update table
            alerts.forEach(alert => {
                const row = document.createElement('tr');
                row.className = 'alert-row';
                row.innerHTML = `
                    <td>${alert.timestamp}</td>
                    <td>${alert.missing_categories}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function addAlertRow(alert) {
            const tbody = document.getElementById('alerts-tbody');

            // Remove "no alerts" message if present
            if (tbody.querySelector('td[colspan="2"]')) {
                tbody.innerHTML = '';
            }

            // Add new alert at the top
            const row = document.createElement('tr');
            row.className = 'alert-row';
            row.innerHTML = `
                <td>${alert.timestamp}</td>
                <td>${alert.missing_categories}</td>
            `;
            tbody.insertBefore(row, tbody.firstChild);

            // Update stats
            const totalAlerts = parseInt(document.getElementById('total-alerts').textContent) + 1;
            document.getElementById('total-alerts').textContent = totalAlerts;

            const categories = alert.missing_categories.toLowerCase();
            if (categories.includes('whole milk')) {
                const wholeAlerts = parseInt(document.getElementById('whole-alerts').textContent) + 1;
                document.getElementById('whole-alerts').textContent = wholeAlerts;
            }
            if (categories.includes('1% milk')) {
                const onePctAlerts = parseInt(document.getElementById('1pct-alerts').textContent) + 1;
                document.getElementById('1pct-alerts').textContent = onePctAlerts;
            }
            if (categories.includes('2% milk')) {
                const twoPctAlerts = parseInt(document.getElementById('2pct-alerts').textContent) + 1;
                document.getElementById('2pct-alerts').textContent = twoPctAlerts;
            }
        }

        // Initialize graph on page load
        initGraph();

        // Load initial graph data
        fetch('/api/data')
            .then(response => response.json())
            .then(data => updateGraph(data))
            .catch(error => console.error('Error loading graph data:', error));

        // Load initial alerts data
        fetch('/api/alerts')
            .then(response => response.json())
            .then(data => updateAlertsTable(data))
            .catch(error => console.error('Error loading alerts data:', error));
    </script>
</body>
</html>
